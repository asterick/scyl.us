#include <stdint.h>
#include <string.h>

#include "system.h"

volatile uint32_t DATA[] = {
	0xDEADFACE,
	0xCAFEBABE,
	0x01234567
};

volatile uint32_t fifo_read[32];

static const uint32_t GPU_TEST[] = {
	GPU_VIEWSTART(0, 0),
	GPU_CLIPPOS(0, 0),
	GPU_CLIPSIZE(256, 240),
	GPU_DRAWCONFIG(GPU_DRAWCONFIG_POS_1_000, GPU_DRAWCONFIG_POS_0_000, GPU_DRAWCONFIG_NEG_1_000, GPU_DRAWCONFIG_POS_0_500) | GPU_DRAWCONFIG_DITHER,
	GPU_CLUT(GPU_CLUT_DISABLED, 0, 0),

	GPU_COMMAND_QUAD | GPU_DRAW_SHADED | 
	GPU_COLOR(   0,    0, 0xFF), GPU_POINT(  0,   0),
	GPU_COLOR(   0, 0xFF,    0), GPU_POINT(  0, 240),
	GPU_COLOR(0xFF, 0xFF, 0xFF), GPU_POINT(256,   0),
	GPU_COLOR(0xFF,    0,    0), GPU_POINT(256, 240),

	GPU_TEXSIZE(0, 0, 0, 0),
	GPU_TEXPOS(0, 0),
	GPU_SETDATA(0, 0, 1, 4),
	0x76543210,
	0xFEDCBA98,

	GPU_CLUT(GPU_CLUT_4BPP, 0, 220),
	GPU_SETDATA(0, 220, 16, 1),
	0x00028000,
	0x00068004,
	0x800A0008,
	0x800E000C,
	0x00128010,
	0x00168014,
	0x801A0018,
	0x801E001C,

	GPU_COMMAND_QUAD | GPU_DRAW_TEXTURED | GPU_DRAW_BLENDED | GPU_COLOR(0xFF,0xFF,0xFF),
	GPU_POINT( 64,  64), GPU_POINT(0, 0),
	GPU_POINT(192,  64), GPU_POINT(4, 0),
	GPU_POINT( 64, 192), GPU_POINT(0, 4),
	GPU_POINT(192, 192), GPU_POINT(4, 4),

	GPU_COMMAND_POINT | GPU_COLOR(0xFF,0,0xFF),
	GPU_POINT(96,  96),

	GPU_COMMAND_POINT | GPU_COLOR(0xFF,0,0xFF),
	GPU_POINT(96, 160),

	GPU_COMMAND_POINT | GPU_COLOR(0xFF,0,0xFF),
	GPU_POINT(160,  96),

	GPU_COMMAND_POINT | GPU_COLOR(0xFF,0,0xFF),
	GPU_POINT(160, 160),

	GPU_COMMAND_LINE | GPU_DRAW_POLY | GPU_COLOR(0xFF,0xFF,0x0),
	GPU_POINT(128,  48),
	GPU_POINT(192, 112),
	GPU_POINT(128, 176),
	GPU_POINT( 64, 112),
	GPU_POINT(128,  48),
	0xFFFFFFFF,

	GPU_GETDATA(0, 0, 1, 4)
};

int main(void) {
	DMA_Channels[1].source = (uint32_t) &GPU_TEST;
	DMA_Channels[1].target = (uint32_t) &GPU_Registers->fifo;
	DMA_Channels[1].length = sizeof(GPU_TEST) / sizeof(GPU_TEST[0]);
	DMA_Channels[1].flags = 0
		| DMA_TRIGGER_GPU_RX_FIFO
		| DMA_WIDTH_BIT32
		| DMACR_ACTIVE_MASK 
		| (4 << DMACR_SSTRIDE_POS)
		| (4 << DMACR_TSTRIDE_POS)
		;

	for (int i = 0; i < 8; i++) {
		fifo_read[i] = GPU_Registers->fifo;
	}
}

void _exit(int status) {
	for (;;) ;
}